<!DOCTYPE html>

<title>FARI - Animal welfare</title>
<link rel = "icon" href ="staticFiles/img/marker.png" type = "image/x-icon">
<html lang="en">
<head>
    <link rel="stylesheet" href="staticFiles/style/style.css">
</head>
<body>
    <div>
        <h1 id="wintxt" class="wintext">+100</h1>
        <h1 id="scoretxt" class="scoretext">Score : 0</h1>
        <h1 id="timer" class="timetext">Time : 0</h1>
    </div>
    
    <img class="logo" src="staticFiles/img/logo.png" alt="FARI Institute">

    <div class="topbar" href="home">
        <ul>
            <li class="current"><a href="{{url_for('play')}}">Restart</a></li>
            <li><a href="{{url_for('leaderboard')}}">Leaderboard</a></li>
            <li><a id="home" href="{{url_for('home')}}">Rules</a></li>
        </ul>
    </div>

    <div id="slider" class="slide"></div>
    <div id="m" class="map"></div>
    <div id="marker" title="Marker"></div>

    <div id="popup" class="popup"> 
        <h1>Game over</h1>
        <p>Your score : <b id="show_score"></b> | Your accuracy : <b id="show_acc"></b> </p>
        <p>AI score : <b id="show_score_AI"></b> | AI accuracy : <b id="show_acc_AI"></b> </p>
        <br>
        <p><b>Choose an username:</b></p>

        <input class="username" type="text" id="username" name="username">
        <a id="button"class="but_save" href="{{url_for('leaderboard')}}">Save</a>
        <br>
        <br>
        <br>
    </div>

    <audio id="audio_win" src="staticFiles/audio/win.mp3"></audio>
    <audio id="audio_lose" src="staticFiles/audio/lose.mp3"></audio>
    <audio id="audio_click" src="staticFiles/audio/ai_click.mp3"></audio>
</body>
</html>

<script src="staticFiles/js/OpenLayers.js"></script>
<script>
    // Show the side window with the informations about the ad
    function createPopup(feature) {
        starttime = Date.now();
        var text = document.getElementById("slider");
        text.innerHTML = feature.attributes.description[0];
        text.style.opacity = '1';
        text.style.marginLeft = 'calc(100% - 385px)';
    }

    // Hide the side window with the informations about the ad
    function destroyPopup() {
        var text = document.getElementById("slider");
        text.style.opacity = '0';
    }

    // Show the side window the informations about the ad
    function showPopup(){
        var text = document.getElementById("slider");
        text.style.opacity = '1';
    }

    // Remove the popup from the map once the user classify it
    function removePopup(id){
        var feature = undefined;
        for (i = 0; i < vectorLayer.features.length; i++) {
            var idd = vectorLayer.features[i]['attributes']['description'][1];
            if(id==idd){
                feature = vectorLayer.features[i];
                break;
            }
        }
        vectorLayer.removeFeatures(feature);
    }
    
    // Action done when the user choose "Legal" or "Illegal" in an ads
    function doAction(gain, id){
        var currenttime = Date.now();
        var deltatime = currenttime - starttime;
        var level = {{level}};
        var value = 0;

        if(gain==0){
            wrong_answers += 1;
            audio_lose.play();
            displaySolution(id, 0);
        }
        else{
            good_answers += 1;
            audio_win.play();
            value = parseInt(gain - (level+2 * (deltatime/1000))); // value depend on the difficulty and time
            if(value < 0){
                value = 5; // If the answer is correct but the player took too much time he get 5 points in anycase
            }
            displaySolution(id, 1);
        }

        var text = document.getElementById("wintxt");
        if(value != 0){ // Show the gain win by the player if it is more than 0
            text.innerHTML = "+" + String(value);
            text.style.display = "block";
            text.style.opacity = '1';
        }

        setTimeout(hideElement, 2000); // Make the gain text disappear progressely 
        function hideElement() {
            text.style.opacity = '0';
        }

        currentscore += value; // value epend on the difficulty and time
        var score = document.getElementById("scoretxt");
        score.innerHTML = "Score : " + String(currentscore);// Put Value
        
        removePopup(id);
    }

    // When the fake AI is playing
    function AIdoAction(gain, id){
        var currenttime = Date.now();
        var deltatime = currenttime - starttime;
        var level = {{level}};
        var value = 0;

        if(gain==0){
            AI_wrong_answers += 1;
            displaySolution(id, 0);
        }
        else{
            AI_good_answers += 1;
            value = parseInt(gain - (level+2 * (deltatime/1000))); // value depend on the difficulty and time
            displaySolution(id, 1);
        }
        var text = document.getElementById("wintxt");
        if(value != 0){ // Show the gain win by the player if it is more than 0
            text.innerHTML = "+" + String(value);
            text.style.display = "block";
            text.style.opacity = '1';
        }
        setTimeout(hideElement, 300); // Make the gain text disappear progressely 
        function hideElement() {
            text.style.opacity = '0';
        }

        AI_currentscore += value; // value epend on the difficulty and time
        var score = document.getElementById("scoretxt");
        score.innerHTML = "Score : " + String(AI_currentscore);// Put Value    
        
    }

    // Function to decrement the timer
    function getTime(){
        if(timer>0){
            timer -= 1;
        }
        document.getElementById("timer").innerHTML = "Time : " + String(timer);
    }

    // Explain why the player's answer is wrong
    function displaySolution(id, solution){
        for (i = 0; i < vectorLayer.features.length; i++) {
            var idd = vectorLayer.features[i]['attributes']['description'][1];
            if(id==idd){
                feature = vectorLayer.features[i];
                var text = document.getElementById("slider");
                text.innerHTML = "<button class='but_close' onclick='closeSolution()'>x</button>";
               
                var iderror = vectorLayer.features[i]['attributes']['description'][3]
                text.scrollTo(0, 0);
                if(solution==0){
                    text.innerHTML += "<div class='markerContent'><h2 class='soluttext_w'>Wrong!</h2>"
                    text.innerHTML += "<hr>"
                    text.innerHTML += "<b><p class='description'>The AI chose the other solution because of the following reason:</p></b>"
                    text.innerHTML += vectorLayer.features[i]['attributes']['description'][2];
                    text.innerHTML += "<hr>"
                    text.innerHTML += "<b><p class='description'>Steps made by the AI to classify this ads:</p></b>";
                    text.innerHTML += vectorLayer.features[i]['attributes']['description'][3];
                    text.innerHTML += "</div>"
                }
                else{
                    text.innerHTML += "<div class='markerContent'><h2 class='soluttext_r'>Correct!</h2>";
                    text.innerHTML += "<hr>"
                    text.innerHTML += "<b><p class='description'>You choose the correct anwser because:</p></b>";
                    text.innerHTML += vectorLayer.features[i]['attributes']['description'][2];
                    text.innerHTML += "<hr>"
                    text.innerHTML += "<b><p class='description'>Steps made by the AI to classify this ads:</p></b>";
                    text.innerHTML += vectorLayer.features[i]['attributes']['description'][3];
                    text.innerHTML += "</div>"
                }
                
                break;
            }
        }
    }
    
    function closeSolution(){
        var text = document.getElementById("slider");
        text.style.opacity = '0';
    }

    // Check if the game is finish
    function checkFinish(){
        if(vectorLayer.features.length == 0 || timer==0){ // Time over or all the ads classified
            if(game_over==0){
                finishtime = Date.now();
                game_over = 1;
                var finishpopup = document.getElementById("popup");
                finishpopup.style.display = "block";
                var finalscore = document.getElementById("show_score");
                finalscore.innerHTML+= currentscore;
                var finalaccuracy = document.getElementById("show_acc");
                var accuracy = good_answers / (good_answers + wrong_answers);
                if(isNaN(accuracy)){accuracy=0;}
                finalaccuracy.innerHTML += Number((accuracy*100).toFixed(1)) + "%";
                var map = document.getElementById("m")
                map.style.pointerEvents = 'none';
                closeSolution();
            }
        }
        if(game_over==1){ // Once the game is over we wait for the user input (username)
            resetMap();
            var currenttime = Date.now();
            var deltatime = currenttime - finishtime;
            if(deltatime > 90000){ // If after 1min30 the user doesn't enter any name we redirect to the starting page
                var btn = document.getElementById("home");
                btn.click();
            }
        }
    }

    // Send the username and score at the end of the game to the server to update the leaderboard
    function sendUsername(){
        var value = document.getElementById("username").value;
        var xmlHttp = new XMLHttpRequest();
        var url = "/getusername/" + String(value)+"---"+String(currentscore)
        xmlHttp.open( "GET", url, false ); // false for synchronous request
        xmlHttp.send(null);
        return xmlHttp.responseText;
    }


    function resetMap(){
        // Put back all the ads on the map
        vectorLayer = new OpenLayers.Layer.Vector("Overlay");
        for (let i = 0; i < ads.length; i++) {
            var feature = new OpenLayers.Feature.Vector(
            new OpenLayers.Geometry.Point( ads[i]['lat'], ads[i]['long'] ).transform(epsg4326, projectTo),
                {description: [ads[i]['description'], ads[i]['id'], ads[i]['error'], ads[i]['whereError']]},
                {externalGraphic: 'staticFiles/img/marker.png', graphicHeight: 40, graphicWidth: 40, graphicXOffset:-25, graphicYOffset:-25}
            );    
            vectorLayer.addFeatures(feature);       
        }
        map.addLayer(vectorLayer);
    }

    function randomIntFromInterval(min, max) { // min and max included 
        return Math.floor(Math.random() * (max - min + 1) + min)
    }

    // When the player has finished the game, the fake AI take its turn
    function PlayAI(){
        if(game_over==1){
            if(AI_current_ad_id < vectorLayer.features.length){
                createPopup(vectorLayer.features[AI_current_ad_id]);
                rndInt = randomIntFromInterval(0, vectorLayer.features.length)
                if(rndInt==0){ // Fake AI make an error
                    AIdoAction(0, AI_current_ad_id); 
                }
                else{
                    AIdoAction(100, AI_current_ad_id);
                }
                AI_current_ad_id += 1;
            }
            else{
                closeSolution();
            }
        }
        var finalscore = document.getElementById("show_score_AI");
        finalscore.innerHTML= AI_currentscore;
        var finalaccuracy = document.getElementById("show_acc_AI");
        var accuracy = AI_good_answers / (AI_good_answers + AI_wrong_answers);
        if(isNaN(accuracy)){accuracy=0;}
        finalaccuracy.innerHTML = Number((accuracy*100).toFixed(1)) + "%";
    }

    

    //=================================================================================
    var currentscore = 0;
    var AI_currentscore = 0;
    var AI_current_ad_id = 0;
    var game_over=0;
    var good_answers = 0; var wrong_answers = 0;
    var AI_good_answers = 0; var AI_wrong_answers = 0;
    var zoom=11; // Zoom on the map
    var starttime = undefined;
    var finishtime = undefined;
    var ads = {{ads|tojson}}; // Set of ads
    var map = new OpenLayers.Map("m");
    var audio_lose = document.getElementById("audio_lose"); // Play lose sound
    var audio_win = document.getElementById("audio_win"); // Play win sound
    var audio_click = document.getElementById("audio_click");

    var level = {{level}}; // Difficulty level
    var timer = 600; // 10min (Eazy mode - Default)
    if(level==1){
        timer=420; // 7min (Normal mode)
    }
    else if(level==2){
        timer=300; // 5min (Hard mode)
    }
    
    // Map stuff
    map.addLayer(new OpenLayers.Layer.OSM());
    epsg4326 =  new OpenLayers.Projection("EPSG:4326"); //WGS 1984 projection
    projectTo = map.getProjectionObject(); //The map projection (Spherical Mercator)
    var lonLat = new OpenLayers.LonLat(4.350665, 50.848638).transform(epsg4326, projectTo);
    map.setCenter(lonLat, zoom);
    var vectorLayer = new OpenLayers.Layer.Vector("Overlay");
    
    resetMap();
    
    // Controler for click on the pin in the map
    var controls = {
      selector: new OpenLayers.Control.SelectFeature(vectorLayer, { onSelect: createPopup, onUnselect: destroyPopup })
    };
    map.addControl(controls['selector']);
    controls['selector'].activate();


    // Timer and end game conditions
    setInterval(()=>{getTime()},1000);
    setInterval(()=>{checkFinish()},500);
    setInterval(()=>{PlayAI()},500);
    
    var btn = document.getElementById("button");
	btn.addEventListener("click", sendUsername);


</script>
