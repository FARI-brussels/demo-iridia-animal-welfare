<!DOCTYPE html>

<title>FARI - Animal welfare</title>
<link rel = "icon" href ="staticFiles/img/marker.png" type = "image/x-icon">
<html lang="en">

<head>
    <link rel="stylesheet" href="staticFiles/style/style.css">
</head>

<body>
    <div>
        <h1 id="wintxt" class="wintext">+100</h1>
        <h1 id="scoretxt" class="scoretext">Score : 0</h1>
        <h1 id="timer" class="timetext">Time : 0</h1>
    </div>
    
    <img class="logo" src="staticFiles/img/logo.png" alt="FARI Institute">

    <div class="topbar" href="home">
        <ul>
            <li class="current"><a href="{{url_for('play')}}">Restart</a></li>
            <li><a href="{{url_for('leaderboard')}}">Leaderboard</a></li>
            <li><a href="{{url_for('home')}}">Rules</a></li>
        </ul>
    </div>

    <div id="slider" class="slide"></div>
    <div id="m" class="map"></div>
    <div id="marker" title="Marker"></div>

    <div id="popup" class="popup"> 
        <h1>Finish</h1>
        <p>Choose an username</p>

        <input class="username" type="text" id="username" name="username">
        <a id="button"class="but_save" href="{{url_for('leaderboard')}}">Save</a>
        <br>
        <br>
        <br>
    </div>

    <audio id="audio_win" src="staticFiles/audio/win.mp3"></audio>
    <audio id="audio_lose" src="staticFiles/audio/lose.mp3"></audio>
</body>
</html>

<script src="staticFiles/js/OpenLayers.js"></script>
<script>
    // Show the side window with the informations about the ad
    function createPopup(feature) {
        starttime = Date.now();
        var text = document.getElementById("slider");
        text.innerHTML = feature.attributes.description[0];
        text.style.opacity = '1';
        text.style.marginLeft = 'calc(100% - 385px)';
    }

    // Hide the side window with the informations about the ad
    function destroyPopup(feature) {
        var text = document.getElementById("slider");
        text.innerHTML = feature.attributes.description;
        text.style.opacity = '0';
    }

    // Remove the popup from the map once the user classify it
    function removePopup(id){
        var feature = undefined;
        for (i = 0; i < vectorLayer.features.length; i++) {
            var idd = vectorLayer.features[i]['attributes']['description'][1];
            if(id==idd){
                feature = vectorLayer.features[i];
                break;
            }
        }
        vectorLayer.removeFeatures(feature);
        destroyPopup(feature);
    }
    
    // Action done when the user choose "Legal" or "Illegal" in an ads
    function doAction(gain, id){
        var currenttime = Date.now();
        var deltatime = currenttime - starttime;
        var level = {{level}};
        var value = 0;

        if(gain==0){
            var audio = document.getElementById("audio_lose"); // Play lose sound
            audio.play();
            displaySolution(id);
        }
        else{
            var audio = document.getElementById("audio_win"); // Play win sound
            audio.play();
            value = parseInt(gain - (level+2 * (deltatime/1000))); // value depend on the difficulty and time
            if(value < 0){
                value = 5; // If the answer is correct but the player took too much time he get 5 points in anycase
            }
        }

        var text = document.getElementById("wintxt");
        if(value != 0){ // Show the gain win by the player if it is more than 0
            text.innerHTML = "+" + String(value);
            text.style.display = "block";
            text.style.opacity = '1';
        }

        setTimeout(hideElement, 2000); // Make the gain text disappear progressely 
        function hideElement() {
            text.style.opacity = '0';
        }

        currentscore += value; // value epend on the difficulty and time
        var score = document.getElementById("scoretxt");
        score.innerHTML = "Score : " + String(currentscore);// Put Value
        if(gain==0){
            setTimeout(function() {
                removePopup(id);
            }, 3000);
        }
        else{
            removePopup(id);
        }
    }

    // Function to decrement the timer
    function getTime(){
        if(timer>0){
            timer -= 1;
        }
        document.getElementById("timer").innerHTML = "Time : " + String(timer);
    }

    // Explain why the player's answer is wrong
    function displaySolution(id){
        for (i = 0; i < vectorLayer.features.length; i++) {
            var idd = vectorLayer.features[i]['attributes']['description'][1];
            if(id==idd){
                console.log(id);
                feature = vectorLayer.features[i];
                var text = document.getElementById("slider");
                text.innerHTML = "<div class='markerContent'><h2 class='soluttext'>Wrong!</h2>"
                text.innerHTML += "<p class='description'>The AI chose the other solution because of the following reason:</p>"
                text.innerHTML += vectorLayer.features[i]['attributes']['description'][2];
                text.innerHTML += "</div>"
                break;
            }
        }
    }
    
    // Check if the game is finish
    function checkFinish(){
        if(vectorLayer.features.length == 0){
            var finishpopup = document.getElementById("popup");
            finishpopup.style.display = "block";
        }
        if(timer==0){
            var finishpopup = document.getElementById("popup");
            finishpopup.style.display = "block";
        }
    }

    // Send the username and score at the end of the game to the server to update the leaderboard
    function sendUsername(){
        var value = document.getElementById("username").value;
        var xmlHttp = new XMLHttpRequest();
        var url = "/getusername/" + String(value)+"---"+String(currentscore)
        xmlHttp.open( "GET", url, false ); // false for synchronous request
        xmlHttp.send(null);
        return xmlHttp.responseText;
    }

    //=================================================================================
    var currentscore = 0;
    var zoom=11; // Zoom on the map
    var starttime = undefined;
    var ads = {{ads|tojson}}; // Set of ads
    var map = new OpenLayers.Map("m");
    var level = {{level}}; // Difficulty level
    var timer = 600; // 10min (Eazy mode - Default)
    if(level==1){
        timer=420; // 7min (Normal mode)
    }
    else if(level==2){
        timer=300; // 5min (Hard mode)
    }
    
    // Map stuff
    map.addLayer(new OpenLayers.Layer.OSM());
    epsg4326 =  new OpenLayers.Projection("EPSG:4326"); //WGS 1984 projection
    projectTo = map.getProjectionObject(); //The map projection (Spherical Mercator)
    var lonLat = new OpenLayers.LonLat(4.350665, 50.848638).transform(epsg4326, projectTo);
    map.setCenter(lonLat, zoom);
    var vectorLayer = new OpenLayers.Layer.Vector("Overlay");
    
    // Ads the different ads to the map
    for (let i = 0; i < ads.length; i++) {
        var feature = new OpenLayers.Feature.Vector(
        new OpenLayers.Geometry.Point( ads[i]['lat'], ads[i]['long'] ).transform(epsg4326, projectTo),
            {description: [ads[i]['description'], ads[i]['id'], ads[i]['error']]},
            {externalGraphic: 'staticFiles/img/marker.png', graphicHeight: 40, graphicWidth: 40, graphicXOffset:-25, graphicYOffset:-25}
        );    
        vectorLayer.addFeatures(feature);       
    }

    map.addLayer(vectorLayer);
    
    // Controler for click on the pin in the map
    var controls = {
      selector: new OpenLayers.Control.SelectFeature(vectorLayer, { onSelect: createPopup, onUnselect: destroyPopup })
    };
    map.addControl(controls['selector']);
    controls['selector'].activate();

    // Timer and end game conditions
    var timerId= setInterval(()=>{getTime()},1000);
    setInterval(()=>{checkFinish()},500);

    // Check when the player send its username
    var btn = document.getElementById("button");
	btn.addEventListener("click", sendUsername);

</script>
